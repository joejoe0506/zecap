import socket
import struct
import os

save_dir = "/home/pi/received_faces"
folders = ["0", "1", "2"]

# í´ë” ìƒì„±
for f in folders:
    os.makedirs(os.path.join(save_dir, f), exist_ok=True)

server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server_socket.bind(('0.0.0.0', 8485))
server_socket.listen(1)
print("ğŸ“¡ ì–¼êµ´ ì´ë¯¸ì§€ ìˆ˜ì‹  ëŒ€ê¸°ì¤‘...")

conn, addr = server_socket.accept()
print("ğŸ”— ì—°ê²°ë¨:", addr)

try:
    # ë°ì´í„° í¬ê¸° ë°›ê¸° (4ë°”ì´íŠ¸)
    data = conn.recv(4)
    if data:
        (size,) = struct.unpack(">L", data)

        # ì´ë¯¸ì§€ ë°ì´í„° ë°›ê¸°
        img_data = b''
        while len(img_data) < size:
            packet = conn.recv(4096)
            if not packet:
                break
            img_data += packet

        # í´ë” ìë™ ë¶„ë¥˜
        folder = folders[len(os.listdir(os.path.join(save_dir, "0"))) % 3]
        path = os.path.join(save_dir, folder, f"face_{len(os.listdir(os.path.join(save_dir, folder)))}.jpg")

        with open(path, "wb") as f:
            f.write(img_data)
        print(f"âœ… ì–¼êµ´ ì €ì¥ ì™„ë£Œ: {path}")

except Exception as e:
    print("âš ï¸ ì˜¤ë¥˜:", e)

finally:
    conn.close()
    server_socket.close()
    print("ğŸ§© ì„œë²„ ì¢…ë£Œ")
