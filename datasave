import socket
import struct
import os

save_dir = "/home/pi/received_faces"
folders = ["0", "1", "2"]

# 폴더 생성
for f in folders:
    os.makedirs(os.path.join(save_dir, f), exist_ok=True)

server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server_socket.bind(('0.0.0.0', 8485))
server_socket.listen(1)
print("📡 얼굴 이미지 수신 대기중...")

conn, addr = server_socket.accept()
print("🔗 연결됨:", addr)

try:
    # 데이터 크기 받기 (4바이트)
    data = conn.recv(4)
    if data:
        (size,) = struct.unpack(">L", data)

        # 이미지 데이터 받기
        img_data = b''
        while len(img_data) < size:
            packet = conn.recv(4096)
            if not packet:
                break
            img_data += packet

        # 폴더 자동 분류
        folder = folders[len(os.listdir(os.path.join(save_dir, "0"))) % 3]
        path = os.path.join(save_dir, folder, f"face_{len(os.listdir(os.path.join(save_dir, folder)))}.jpg")

        with open(path, "wb") as f:
            f.write(img_data)
        print(f"✅ 얼굴 저장 완료: {path}")

except Exception as e:
    print("⚠️ 오류:", e)

finally:
    conn.close()
    server_socket.close()
    print("🧩 서버 종료")
